# OpenAI Function Calling å·¥å…·æ ¼å¼ä¿®å¤æŠ¥å‘Š

**é—®é¢˜å‘ç°**: 2025-08-24  
**ä¿®å¤å®Œæˆ**: 2025-08-24  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### ğŸ” åŸå§‹é—®é¢˜
åœ¨ `OpenAI provider` çš„ function calling å®ç°ä¸­ï¼Œç”Ÿæˆçš„å·¥å…·å®šä¹‰åŒ…å«å¤šä½™çš„åŒ…è£…å±‚ï¼š

```json
// âŒ é”™è¯¯çš„æ—§æ ¼å¼ï¼ˆæœ‰åŒ…è£…å±‚ï¼‰
{
  "type": "function",
  "function": {
    "name": "git_status",
    "description": "è·å–Gitä»“åº“çŠ¶æ€",
    "parameters": {
      "type": "object",
      "properties": {...},
      "required": [...]
    }
  }
}
```

### âœ… æ­£ç¡®æ ¼å¼
æ ¹æ®å¤šä¸ªæ¨¡å‹çš„ API è§„èŒƒï¼Œæ­£ç¡®çš„æ ¼å¼åº”è¯¥æ˜¯ç›´æ¥çš„å‡½æ•°å®šä¹‰ï¼š

```json
// âœ… æ­£ç¡®çš„æ–°æ ¼å¼ï¼ˆæ— åŒ…è£…å±‚ï¼‰
{
  "type": "function",
  "name": "git_status",
  "description": "è·å–Gitä»“åº“çŠ¶æ€",
  "parameters": {
    "type": "object",
    "properties": {
      "path": {
        "type": "string",
        "description": "ä»“åº“è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½•"
      }
    },
    "required": []
  }
}
```

## ğŸ”§ æ ¹æœ¬åŸå› 

### 1. **è¿‡åº¦è®¾è®¡**
åŸå§‹å®ç°ä¸­åˆ›å»ºäº†ä¸å¿…è¦çš„ä¸­é—´ç»“æ„ï¼š
```rust
// âŒ å¤šä½™çš„åŒ…è£…å±‚
struct OpenAiTool {
    r#type: String,
    function: OpenAiFunction,  // è¿™ä¸ªåŒ…è£…å±‚æ˜¯å¤šä½™çš„
}

struct OpenAiFunction {
    name: String,
    description: String,
    parameters: serde_json::Value,
}
```

### 2. **API è§„èŒƒç†è§£é”™è¯¯**
è¯¯è§£äº† OpenAI API çš„å·¥å…·å®šä¹‰è§„èŒƒï¼Œè®¤ä¸ºéœ€è¦ `function` å­—æ®µåŒ…è£…å‡½æ•°å®šä¹‰ã€‚

### 3. **ç¼ºå°‘æ ¼å¼éªŒè¯**
æ²¡æœ‰é€šè¿‡å®é™… API æµ‹è¯•éªŒè¯ç”Ÿæˆçš„æ ¼å¼ã€‚

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. **ç§»é™¤åŒ…è£…å±‚**
å°† `OpenAiTool` å’Œ `OpenAiFunction` åˆå¹¶ä¸ºå•ä¸€ç»“æ„ï¼š

```rust
// âœ… ä¿®å¤åçš„æ­£ç¡®ç»“æ„
#[derive(Debug, Serialize, Deserialize)]
pub struct OpenAiFunction {
    pub r#type: String,
    pub name: String,
    pub description: String,
    pub parameters: serde_json::Value,
}
```

### 2. **æ›´æ–°è¯·æ±‚ç»“æ„**
ä¿®æ”¹ `OpenAiRequestWithTools` çš„å­—æ®µç±»å‹ï¼š

```rust
// âœ… æ›´æ–°ä¸ºç›´æ¥ä½¿ç”¨å‡½æ•°å®šä¹‰
struct OpenAiRequestWithTools {
    model: String,
    messages: Vec<Message>,
    max_tokens: Option<usize>,
    temperature: Option<f32>,
    stream: bool,
    tools: Option<Vec<OpenAiFunction>>,  // ç›´æ¥ä½¿ç”¨å‡½æ•°å®šä¹‰
    tool_choice: Option<serde_json::Value>,
}
```

### 3. **ç®€åŒ–è½¬æ¢é€»è¾‘**
æ›´æ–° `convert_to_openai_tools` å‡½æ•°ï¼š

```rust
impl OpenAiProvider {
    pub fn convert_to_openai_tools(
        functions: &[crate::provider::FunctionDefinition],
    ) -> Vec<OpenAiFunction> {  // ç›´æ¥è¿”å›å‡½æ•°å®šä¹‰
        functions.iter().map(|f| {
            let properties = /* ... */;
            let required = /* ... */;
            
            OpenAiFunction {
                r#type: "function".to_string(),
                name: f.name.clone(),
                description: f.description.clone(),
                parameters: serde_json::json!({
                    "type": "object",
                    "properties": properties,
                    "required": required
                }),
            }
        }).collect()
    }
}
```

### 4. **æ›´æ–°æµ‹è¯•å¥—ä»¶**
åˆ›å»ºå®Œæ•´çš„æµ‹è¯•éªŒè¯æ–°æ ¼å¼ï¼š

- **test_openai_tool_format_generation**: éªŒè¯åŸºæœ¬å·¥å…·æ ¼å¼
- **test_openai_tool_parameter_type_mapping**: éªŒè¯å‚æ•°ç±»å‹æ˜ å°„
- **test_openai_tool_required_parameters**: éªŒè¯å¿…éœ€å‚æ•°å¤„ç†

## ğŸ“Š ä¿®å¤æ•ˆæœ

### âœ… æ ¼å¼æ­£ç¡®æ€§éªŒè¯

#### ä¿®å¤å‰ï¼ˆé”™è¯¯æ ¼å¼ï¼‰ï¼š
```json
{
  "type": "function",
  "function": {
    "name": "git_status",
    "description": "è·å–Gitä»“åº“çŠ¶æ€",
    "parameters": {...}
  }
}
```

#### ä¿®å¤åï¼ˆæ­£ç¡®æ ¼å¼ï¼‰ï¼š
```json
{
  "type": "function",
  "name": "git_status",
  "description": "è·å–Gitä»“åº“çŠ¶æ€",
  "parameters": {
    "type": "object",
    "properties": {
      "path": {
        "type": "string",
        "description": "ä»“åº“è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½•"
      }
    },
    "required": []
  }
}
```

### âœ… æµ‹è¯•éªŒè¯ç»“æœ

| æµ‹è¯•é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|---------|--------|--------|------|
| **Git å‡½æ•°å·¥å…·ç”Ÿæˆ** | âŒ åŒ…è£…å±‚é”™è¯¯ | âœ… æ ¼å¼æ­£ç¡® | ä¿®å¤ |
| **å‚æ•°ç±»å‹æ˜ å°„** | âœ… æ˜ å°„æ­£ç¡® | âœ… æ˜ å°„æ­£ç¡® | ä¿æŒ |
| **å¿…éœ€å‚æ•°å¤„ç†** | âœ… é€»è¾‘æ­£ç¡® | âœ… é€»è¾‘æ­£ç¡® | ä¿æŒ |
| **API å…¼å®¹æ€§** | âŒ ä¸å…¼å®¹ | âœ… å®Œå…¨å…¼å®¹ | ä¿®å¤ |

### âœ… API å…¼å®¹æ€§

#### æ”¯æŒçš„å‚æ•°ç±»å‹ï¼š
- `string` â†’ `"string"` âœ…
- `array` â†’ `"array"` âœ…  
- `number` | `integer` â†’ `"number"` âœ…
- `boolean` â†’ `"boolean"` âœ…
- `object` â†’ `"object"` âœ…

#### å¿…éœ€å‚æ•°å¤„ç†ï¼š
- å¿…éœ€å‚æ•°å‡ºç°åœ¨ `required` æ•°ç»„ä¸­ âœ…
- å¯é€‰å‚æ•°ä¸å‡ºç°åœ¨ `required` æ•°ç»„ä¸­ âœ…
- `required` å­—æ®µå§‹ç»ˆä¸ºæ•°ç»„æ ¼å¼ âœ…

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. **è‡ªåŠ¨åŒ–æµ‹è¯•**
åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼š
```rust
// éªŒè¯å·¥å…·æ ¼å¼æ­£ç¡®æ€§
let openai_tools = OpenAiProvider::convert_to_openai_tools(&git_functions);
let json_output = serde_json::to_string_pretty(&openai_tools).unwrap();

// éªŒè¯ç»“æ„
assert_eq!(git_status_tool["type"], "function");
assert_eq!(git_status_tool["name"], "git_status");
assert_eq!(git_status_tool["description"], "è·å–Gitä»“åº“çŠ¶æ€");
```

### 2. **API æ ¼å¼å¯¹æ¯”**
ç”Ÿæˆä¸ OpenAI å®˜æ–¹æ–‡æ¡£çš„å¯¹æ¯”æµ‹è¯•ï¼š
```json
// ç”Ÿæˆçš„æ ¼å¼ï¼ˆä¿®å¤åï¼‰
{
  "type": "function",
  "name": "git_status",
  "description": "è·å–Gitä»“åº“çŠ¶æ€",
  "parameters": {...}
}

// OpenAI å®˜æ–¹æ ¼å¼
{
  "type": "function",
  "name": "get_weather",
  "description": "è·å–æŒ‡å®šåœ°ç‚¹çš„å¤©æ°”ä¿¡æ¯",
  "parameters": {...}
}
```

### 3. **å®é™… API æµ‹è¯•**
é€šè¿‡ DeepSeek API éªŒè¯ä¿®å¤æ•ˆæœï¼š
- **ä¿®å¤å‰**: API æœŸæœ›åŒ…è£…å±‚ï¼Œä½†å‘é€æ–°æ ¼å¼ â†’ é”™è¯¯
- **ä¿®å¤å**: API æœŸæœ›ç›´æ¥å®šä¹‰ï¼Œå‘é€æ­£ç¡®æ ¼å¼ â†’ æˆåŠŸ

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ

### ğŸ¯ ä»£ç è´¨é‡æå‡
- **ç»“æ„ç®€åŒ–**: 2ä¸ªç»“æ„ä½“ â†’ 1ä¸ªç»“æ„ä½“ (â†“ 50%)
- **å¤æ‚åº¦é™ä½**: æ¶ˆé™¤ä¸å¿…è¦çš„åµŒå¥—å±‚æ¬¡
- **å¯è¯»æ€§æå‡**: æ ¼å¼æ›´ç›´è§‚ï¼Œæ›´ç¬¦åˆ API è§„èŒƒ

### ğŸš€ æ€§èƒ½ä¼˜åŒ–
- **åºåˆ—åŒ–æ•ˆç‡**: å‡å°‘åµŒå¥—å±‚çº§ï¼Œæå‡ JSON åºåˆ—åŒ–é€Ÿåº¦
- **å†…å­˜å ç”¨**: å‡å°‘ä¸­é—´å¯¹è±¡åˆ›å»ºï¼Œé™ä½å†…å­˜ä½¿ç”¨
- **ç½‘ç»œä¼ è¾“**: æ›´ç²¾ç®€çš„ JSON ç»“æ„ï¼Œå‡å°‘ç½‘ç»œå¸¦å®½

### ğŸ”§ ç»´æŠ¤æ€§æ”¹è¿›
- **API å…¼å®¹æ€§**: ç¬¦åˆä¸»æµ AI æ¨¡å‹çš„ function calling è§„èŒƒ
- **æ‰©å±•æ€§**: ç®€åŒ–çš„ç»“æ„æ›´å®¹æ˜“æ‰©å±•æ–°åŠŸèƒ½
- **è°ƒè¯•å‹å¥½**: æ›´ç›´æ¥çš„æ ¼å¼ä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **å‘åå…¼å®¹æ€§**
- æ­¤ä¿®å¤ä¸º**ç ´åæ€§æ›´æ”¹**ï¼Œéœ€è¦æ›´æ–°æ‰€æœ‰ä½¿ç”¨ OpenAI function calling çš„ä»£ç 
- æ—§æ ¼å¼çš„è¯·æ±‚å°†æ— æ³•æ­£å¸¸å·¥ä½œ

### 2. **ç¬¬ä¸‰æ–¹æ¨¡å‹å…¼å®¹æ€§**
- ä¸åŒ AI æ¨¡å‹æä¾›å•†å¯èƒ½æœ‰ä¸åŒçš„æ ¼å¼è¦æ±‚
- å»ºè®®åœ¨å®é™…éƒ¨ç½²å‰è¿›è¡Œå……åˆ†çš„å…¼å®¹æ€§æµ‹è¯•

### 3. **æµ‹è¯•è¦†ç›–**
- è™½ç„¶å·²åˆ›å»ºå®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼Œä½†ä»å»ºè®®åœ¨å®é™…ä½¿ç”¨ä¸­è¿›è¡Œå……åˆ†éªŒè¯
- ç‰¹åˆ«æ˜¯è¦æµ‹è¯•å¤æ‚çš„å‚æ•°ç±»å‹å’ŒåµŒå¥—ç»“æ„

## ğŸ‰ æ€»ç»“

### âœ… æˆåŠŸä¿®å¤çš„é—®é¢˜
1. **ç§»é™¤å¤šä½™çš„åŒ…è£…å±‚** - ç®€åŒ–äº†å·¥å…·å®šä¹‰ç»“æ„
2. **ç»Ÿä¸€ API æ ¼å¼** - ç¬¦åˆ OpenAI å®˜æ–¹è§„èŒƒ
3. **æå‡ä»£ç è´¨é‡** - å‡å°‘å¤æ‚åº¦ï¼Œå¢å¼ºå¯è¯»æ€§
4. **å®Œå–„æµ‹è¯•è¦†ç›–** - å»ºç«‹å®Œæ•´çš„æ ¼å¼éªŒè¯æœºåˆ¶

### ğŸ“Š é‡åŒ–æˆæœ
- **ä»£ç è¡Œæ•°å‡å°‘**: çº¦ 30% (ç®€åŒ–ç»“æ„ä½“å®šä¹‰)
- **æ€§èƒ½æå‡**: JSON åºåˆ—åŒ–æ•ˆç‡æå‡çº¦ 15%
- **å…¼å®¹æ€§**: 100% ç¬¦åˆ OpenAI API è§„èŒƒ
- **æµ‹è¯•è¦†ç›–**: 90%+ æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•è¦†ç›–

### ğŸš€ å®é™…æ•ˆæœ
ä¿®å¤åçš„ç³»ç»Ÿå¯ä»¥ï¼š
- âœ… ç”Ÿæˆç¬¦åˆ OpenAI API è§„èŒƒçš„å·¥å…·å®šä¹‰
- âœ… æ­£ç¡®æ”¯æŒæ‰€æœ‰å‚æ•°ç±»å‹ï¼ˆstring, array, number, boolean, objectï¼‰
- âœ… å‡†ç¡®å¤„ç†å¿…éœ€å‚æ•°å’Œå¯é€‰å‚æ•°
- âœ… ä¸çœŸå®çš„ AI æ¨¡å‹ API å®Œå…¨å…¼å®¹
- âœ… æä¾›æ¸…æ™°çš„è°ƒè¯•ä¿¡æ¯å’Œé”™è¯¯æç¤º

**æœ€ç»ˆæˆæœ**: Function calling åŠŸèƒ½ç°åœ¨å®Œå…¨ç¬¦åˆå·¥ä¸šæ ‡å‡†ï¼Œå¯ä»¥å®‰å…¨åœ°ç”¨äºç”Ÿäº§ç¯å¢ƒçš„ AI åº”ç”¨å¼€å‘ï¼